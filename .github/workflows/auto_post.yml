name: Instagram Auto Post

on:
  schedule:
    # 1æ—¥6å›æŠ•ç¨¿ï¼ˆæ—¥æœ¬æ™‚é–“ 7:00 / 10:00 / 12:00 / 17:00 / 19:00 / 21:30ï¼‰
    - cron: '0 22 * * *'   # JST 7:00  æœã®é€šå‹¤æ™‚é–“
    - cron: '0 1 * * *'    # JST 10:00 åˆå‰ã®ä¼‘æ†©
    - cron: '0 3 * * *'    # JST 12:00 æ˜¼ä¼‘ã¿
    - cron: '0 8 * * *'    # JST 17:00 å¤•æ–¹ã®å¸°å®…æ™‚é–“
    - cron: '0 10 * * *'   # JST 19:00 å¤•é£Ÿå¾Œ
    - cron: '30 12 * * *'  # JST 21:30 å¤œã®ãƒªãƒ©ãƒƒã‚¯ã‚¹ã‚¿ã‚¤ãƒ 
  workflow_dispatch:  # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½

jobs:
  post:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install ffmpeg
        run: sudo apt-get update && sudo apt-get install -y ffmpeg

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Create .env file
        run: |
          echo "INSTAGRAM_ACCESS_TOKEN=${{ secrets.INSTAGRAM_ACCESS_TOKEN }}" > .env
          echo "INSTAGRAM_ACCOUNT_ID=${{ secrets.INSTAGRAM_ACCOUNT_ID }}" >> .env
          echo "RAKUTEN_APP_ID=${{ secrets.RAKUTEN_APP_ID }}" >> .env
          echo "RAKUTEN_ACCESS_KEY=${{ secrets.RAKUTEN_ACCESS_KEY }}" >> .env
          echo "RAKUTEN_AFFILIATE_ID=${{ secrets.RAKUTEN_AFFILIATE_ID }}" >> .env
          echo "AMAZON_ACCESS_KEY=${{ secrets.AMAZON_ACCESS_KEY }}" >> .env
          echo "AMAZON_SECRET_KEY=${{ secrets.AMAZON_SECRET_KEY }}" >> .env
          echo "AMAZON_PARTNER_TAG=${{ secrets.AMAZON_PARTNER_TAG }}" >> .env
          echo "IMGBB_API_KEY=${{ secrets.IMGBB_API_KEY }}" >> .env

      - name: Create token_info.json
        run: |
          echo '{
            "user_token": "${{ secrets.USER_TOKEN }}",
            "page_token": "${{ secrets.INSTAGRAM_ACCESS_TOKEN }}",
            "account_id": "${{ secrets.INSTAGRAM_ACCOUNT_ID }}",
            "last_updated": "2025-01-01T00:00:00"
          }' > token_info.json

      - name: Run auto post
        run: python auto_post.py

      # ãƒˆãƒ¼ã‚¯ãƒ³ãŒæ›´æ–°ã•ã‚ŒãŸå ´åˆã€GitHub Secretsã‚’è‡ªå‹•æ›´æ–°ã™ã‚‹
      - name: Update token secrets if changed
        if: success()
        continue-on-error: true
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          # token_info.json ã‹ã‚‰æœ€æ–°ãƒˆãƒ¼ã‚¯ãƒ³ã‚’èª­ã¿å–ã‚‹
          if [ -f token_info.json ]; then
            NEW_USER_TOKEN=$(python -c "import json; print(json.load(open('token_info.json')).get('user_token',''))")
            NEW_PAGE_TOKEN=$(python -c "import json; print(json.load(open('token_info.json')).get('page_token',''))")
            NEW_ACCOUNT_ID=$(python -c "import json; print(json.load(open('token_info.json')).get('account_id',''))")

            OLD_USER_TOKEN="${{ secrets.USER_TOKEN }}"
            OLD_PAGE_TOKEN="${{ secrets.INSTAGRAM_ACCESS_TOKEN }}"

            # ãƒˆãƒ¼ã‚¯ãƒ³ãŒå¤‰ã‚ã£ã¦ã„ãŸã‚‰Secretsã‚’æ›´æ–°
            if [ -n "$GH_TOKEN" ]; then
              if [ "$NEW_USER_TOKEN" != "$OLD_USER_TOKEN" ] && [ -n "$NEW_USER_TOKEN" ]; then
                echo "ğŸ”„ USER_TOKEN ã‚’æ›´æ–°ä¸­..."
                gh secret set USER_TOKEN --body "$NEW_USER_TOKEN"
                echo "âœ… USER_TOKEN æ›´æ–°å®Œäº†"
              fi
              if [ "$NEW_PAGE_TOKEN" != "$OLD_PAGE_TOKEN" ] && [ -n "$NEW_PAGE_TOKEN" ]; then
                echo "ğŸ”„ INSTAGRAM_ACCESS_TOKEN ã‚’æ›´æ–°ä¸­..."
                gh secret set INSTAGRAM_ACCESS_TOKEN --body "$NEW_PAGE_TOKEN"
                echo "âœ… INSTAGRAM_ACCESS_TOKEN æ›´æ–°å®Œäº†"
              fi
              if [ -n "$NEW_ACCOUNT_ID" ]; then
                gh secret set INSTAGRAM_ACCOUNT_ID --body "$NEW_ACCOUNT_ID"
              fi
            else
              echo "âš ï¸ GH_PAT ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ãƒˆãƒ¼ã‚¯ãƒ³è‡ªå‹•æ›´æ–°ã‚’ã‚¹ã‚­ãƒƒãƒ—ã€‚"
            fi
          fi

      - name: Commit post history
        if: success()
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add post_history.json post_mode.json analytics_data.json token_info.json || true
          git diff --cached --quiet || git commit -m "Update post history & tokens [skip ci]"
          git push || true

      - name: Show log
        if: always()
        run: cat auto_post.log || echo "No log file"
