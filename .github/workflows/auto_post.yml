name: Instagram Auto Post

on:
  schedule:
    # 1日3回投稿（日本時間 8:00 / 12:00 / 20:00）
    - cron: '0 23 * * *'   # JST 8:00 = UTC 23:00(前日)
    - cron: '0 3 * * *'    # JST 12:00 = UTC 3:00
    - cron: '0 11 * * *'   # JST 20:00 = UTC 11:00
  workflow_dispatch:  # 手動実行も可能

jobs:
  post:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Create .env file
        run: |
          echo "INSTAGRAM_ACCESS_TOKEN=${{ secrets.INSTAGRAM_ACCESS_TOKEN }}" > .env
          echo "INSTAGRAM_ACCOUNT_ID=${{ secrets.INSTAGRAM_ACCOUNT_ID }}" >> .env
          echo "RAKUTEN_APP_ID=${{ secrets.RAKUTEN_APP_ID }}" >> .env
          echo "RAKUTEN_ACCESS_KEY=${{ secrets.RAKUTEN_ACCESS_KEY }}" >> .env
          echo "RAKUTEN_AFFILIATE_ID=${{ secrets.RAKUTEN_AFFILIATE_ID }}" >> .env

      - name: Create token_info.json
        run: |
          echo '{
            "user_token": "${{ secrets.USER_TOKEN }}",
            "page_token": "${{ secrets.INSTAGRAM_ACCESS_TOKEN }}",
            "account_id": "${{ secrets.INSTAGRAM_ACCOUNT_ID }}",
            "last_updated": "2025-01-01T00:00:00"
          }' > token_info.json

      - name: Run auto post
        run: python auto_post.py

      - name: Commit post history
        if: success()
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add post_history.json post_mode.json || true
          git diff --cached --quiet || git commit -m "Update post history [skip ci]"
          git push || true

      - name: Show log
        if: always()
        run: cat auto_post.log || echo "No log file"
